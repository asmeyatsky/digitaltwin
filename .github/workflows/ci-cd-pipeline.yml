name: Digital Twin CI/CD Pipeline
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache NuGet packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    - name: Cache Python packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio
        
    - name: Run .NET tests
      run: |
        dotnet test --no-restore --configuration Release --logger "console;verbosity=detailed" --collect:"XPlat Code Coverage"
        
    - name: Run Python tests
      run: |
        python -m pytest tests/ -v --cov=services --cov-report=xml --cov-report=html
        
    - name: Upload test coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml,./coverage.xml
        
    - name: Security scanning
      run: |
        # Install security scanning tools
        pip install safety bandit semgrep
        
        # Run security scans
        safety check -r requirements.txt
        bandit -r services/ -f json -o security-report.json
        semgrep --config=auto services/
        
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: security-report.json
        
    - name: Build .NET applications
      run: |
        dotnet build DigitalTwin.sln --configuration Release --no-restore
        
    - name: Build Docker images
      run: |
        # Build and tag Docker images
        IMAGE_TAG=${{ github.sha }}
        
        # Build API Gateway
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api-gateway:$IMAGE_TAG -f docker-compose.api-gateway.yml .
        
        # Build ML Services
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/deepface-service:$IMAGE_TAG -f services/deepface-service/Dockerfile services/deepface-service/
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/avatar-generation:$IMAGE_TAG -f services/avatar-generation-service/Dockerfile services/avatar-generation-service/
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/voice-service:$IMAGE_TAG -f services/voice-service/Dockerfile services/voice-service/
        
    - name: Log in to Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Push Docker images
      run: |
        IMAGE_TAG=${{ github.sha }}
        
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api-gateway:$IMAGE_TAG
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/deepface-service:$IMAGE_TAG
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/avatar-generation:$IMAGE_TAG
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/voice-service:$IMAGE_TAG
        
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api-gateway:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/deepface-service:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/avatar-generation:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/voice-service:${{ github.sha }}

  deploy-staging:
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to staging
      run: |
        echo "ðŸš€ Deploying to staging environment..."
        
        # Update staging Kubernetes manifests
        sed -i 's/IMAGE_TAG/${{ needs.test-and-build.outputs.image-tag }}/g' k8s/staging/*.yaml
        
        # Deploy to staging
        kubectl apply -f k8s/staging/
        
        # Wait for rollout
        kubectl rollout status deployment/digitaltwin-api -n staging
        kubectl rollout status deployment/deepface-service -n staging
        
        echo "âœ… Staging deployment completed"

  deploy-production:
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to production
      run: |
        echo "ðŸš€ Deploying to production environment..."
        
        # Update production Kubernetes manifests
        sed -i 's/IMAGE_TAG/${{ needs.test-and-build.outputs.image-tag }}/g' k8s/production/*.yaml
        
        # Deploy to production with gradual rollout
        kubectl apply -f k8s/production/
        
        # Perform rolling update with 25% increments
        kubectl set image deployment/digitaltwin-api ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api-gateway:${{ needs.test-and-build.outputs.image-tag }} -n production --record
        kubectl rollout status deployment/digitaltwin-api -n production
        
        echo "âœ… Production deployment completed"

  ml-training:
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && contains(github.ref, 'refs/heads/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install ML dependencies
      run: |
        pip install -r requirements.txt
        pip install mlflow optuna
        
    - name: Train voice emotion models
      run: |
        echo "ðŸ§  Training voice emotion detection models..."
        python scripts/setup-ml-pipeline.py
        
    - name: Log training metrics
      run: |
        mlflow ui --port 5000 &
        sleep 5
        echo "ðŸ“Š Training metrics available at: http://localhost:5000"

  performance-testing:
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup performance testing
      run: |
        pip install locust k6
        
    - name: Load test API
      run: |
        locust -f tests/performance/api-load-test.py --headless --html report.html --host http://staging.digitaltwin.com
        
    - name: Load test ML services
      run: |
        k6 run tests/performance/ml-load-test.js --out results.json --http http://staging.digitaltwin.com
        
    - name: Upload performance reports
      uses: actions/upload-artifact@v3
      with:
        name: performance-reports
        path: report.html,results.json

  security-scan:
    needs: test-and-build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Container security scanning
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api-gateway:${{ needs.test-and-build.outputs.image-tag }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Dependency vulnerability scanning
      run: |
        pip install safety
        safety check --json --output safety-report.json
        pip-audit --output audit-report.json
        
    - name: Code security scanning
      uses: semgrep/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/security
        all: true
        generate-sarif: 'true'
        output: 'semgrep-results.sarif'
        
    - name: Upload container security scans
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
        category: container-image
        
    - name: Upload code security scans
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'semgrep-results.sarif'
        category: code

  rollback:
    needs: deploy-production
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
    - name: Rollback deployment
      run: |
        echo "ðŸš¨ Rolling back production deployment..."
        
        # Rollback to previous stable version
        kubectl rollout undo deployment/digitaltwin-api -n production
        kubectl rollout status deployment/digitaltwin-api -n production
        
        echo "âœ… Rollback completed"